<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECharts in Markdown PoC</title>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="./library/marked.umd.js"></script>
    
    <!-- ECharts -->
    <script src="./library/echarts.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        
        h1, h2, h3, h4 {
            color: #4fc3f7;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }
        
        th, td {
            border: 1px solid #444;
            padding: 8px 12px;
            text-align: left;
        }
        
        th {
            background: #2a2a4a;
        }
        
        tr:nth-child(even) {
            background: #252540;
        }
        
        /* Chart container styling */
        .echart-container {
            width: 100%;
            height: 300px;
            margin: 16px 0;
            background: #252540;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .echart-container.pie-chart {
            height: 350px;
        }
        
        .echart-container.bar-chart {
            height: 400px;
        }
        
        /* Debug panel */
        #debug {
            background: #0d0d1a;
            padding: 12px;
            border-radius: 4px;
            margin-top: 30px;
            font-family: monospace;
            font-size: 12px;
            color: #888;
        }
        
        blockquote {
            border-left: 4px solid #4fc3f7;
            margin: 16px 0;
            padding: 8px 16px;
            background: #252540;
        }
        
        code {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="report-content"></div>
    <div id="debug"></div>

    <script>
        // Sample Markdown content with embedded chart placeholders
        const markdownContent = `
# Benchmark Report - ECharts Integration PoC

## Executive Summary

Key results from performance benchmarks comparing FEM solver implementations.

> **Aggregated Results:** Data from 3 servers. Values shown are mean ± std across all runs.

**Y-Shaped (L)** (763,707 nodes)

| Implementation | Total Time | Speedup vs Baseline | N |
|----------------|------------|---------------------|---|
| CPU Baseline | 320.45s ± 12.3s | 1.0x | 6 |
| CPU Threaded | 298.12s ± 8.5s | 1.1x | 6 |
| Numba CPU | 45.23s ± 2.1s | 7.1x | 6 |
| CuPy GPU | 4.23s ± 0.15s | 75.8x | 6 |

## Time Distribution Analysis

### CPU Baseline Bottleneck

<div class="echart-container pie-chart" data-chart='{
    "type": "pie",
    "title": "CPU Baseline - Time Distribution",
    "data": [
        {"name": "Assembly", "value": 45.2},
        {"name": "Solve", "value": 38.5},
        {"name": "Apply BC", "value": 12.1},
        {"name": "Post-Process", "value": 4.2}
    ]
}'></div>

### GPU (CuPy) Bottleneck

<div class="echart-container pie-chart" data-chart='{
    "type": "pie",
    "title": "CuPy GPU - Time Distribution",
    "data": [
        {"name": "Assembly", "value": 8.3},
        {"name": "Solve", "value": 78.2},
        {"name": "Apply BC", "value": 9.1},
        {"name": "Post-Process", "value": 4.4}
    ]
}'></div>

## Speedup Comparison

<div class="echart-container bar-chart" data-chart='{
    "type": "bar",
    "title": "Speedup vs CPU Baseline by Mesh Size",
    "categories": ["XS (201)", "S (50K)", "M (200K)", "L (763K)"],
    "series": [
        {"name": "CPU Threaded", "data": [1.0, 1.1, 1.1, 1.1]},
        {"name": "Numba CPU", "data": [2.1, 4.5, 6.2, 7.1]},
        {"name": "CuPy GPU", "data": [0.8, 12.5, 45.2, 75.8]}
    ]
}'></div>

## Stage Timing Comparison

<div class="echart-container bar-chart" data-chart='{
    "type": "stacked-bar",
    "title": "Stage Breakdown by Implementation",
    "categories": ["CPU Baseline", "CPU Threaded", "Numba CPU", "CuPy GPU"],
    "series": [
        {"name": "Load Mesh", "data": [0.5, 0.5, 0.5, 0.5]},
        {"name": "Assembly", "data": [145.2, 142.1, 22.5, 0.35]},
        {"name": "Apply BC", "data": [38.8, 35.2, 5.2, 0.38]},
        {"name": "Solve", "data": [123.5, 108.2, 14.8, 3.31]},
        {"name": "Post-Process", "data": [12.5, 12.1, 2.2, 0.19]}
    ]
}'></div>

## Conclusions

1. **Maximum Speedup:** CuPy GPU achieves 75.8x speedup over CPU Baseline.
2. **Bottleneck Shift:** CPU is bottlenecked by Assembly (45%), GPU by Solve (78%).
3. **Scaling:** GPU advantage increases with problem size.
`;

        // Chart theme matching dark UI
        const chartTheme = {
            backgroundColor: 'transparent',
            textStyle: {
                color: '#ccc'
            },
            title: {
                textStyle: {
                    color: '#4fc3f7'
                }
            },
            legend: {
                textStyle: {
                    color: '#ccc'
                }
            }
        };

        // Color palette
        const colors = ['#4CAF50', '#2196F3', '#FF9800', '#E91E63', '#9C27B0', '#00BCD4'];

        // Build ECharts option from our simplified config
        function buildChartOption(config) {
            const baseOption = {
                backgroundColor: 'transparent',
                textStyle: { color: '#ccc' },
                title: {
                    text: config.title || '',
                    left: 'center',
                    textStyle: { color: '#4fc3f7', fontSize: 14 }
                },
                tooltip: {
                    trigger: config.type === 'pie' ? 'item' : 'axis'
                },
                color: colors
            };

            if (config.type === 'pie') {
                return {
                    ...baseOption,
                    tooltip: {
                        trigger: 'item',
                        formatter: '{b}: {c}% ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        right: 20,
                        top: 'center',
                        textStyle: { color: '#ccc' }
                    },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['40%', '55%'],
                        avoidLabelOverlap: true,
                        itemStyle: {
                            borderRadius: 4,
                            borderColor: '#1a1a2e',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            formatter: '{b}: {c}%',
                            color: '#ccc'
                        },
                        data: config.data
                    }]
                };
            }

            if (config.type === 'bar') {
                return {
                    ...baseOption,
                    legend: {
                        data: config.series.map(s => s.name),
                        bottom: 10,
                        textStyle: { color: '#ccc' }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: config.categories,
                        axisLabel: { color: '#ccc' },
                        axisLine: { lineStyle: { color: '#444' } }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Speedup (x)',
                        axisLabel: { color: '#ccc' },
                        axisLine: { lineStyle: { color: '#444' } },
                        splitLine: { lineStyle: { color: '#333' } }
                    },
                    series: config.series.map(s => ({
                        name: s.name,
                        type: 'bar',
                        data: s.data,
                        barGap: '10%'
                    }))
                };
            }

            if (config.type === 'stacked-bar') {
                return {
                    ...baseOption,
                    legend: {
                        data: config.series.map(s => s.name),
                        bottom: 10,
                        textStyle: { color: '#ccc' }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: config.categories,
                        axisLabel: { color: '#ccc' },
                        axisLine: { lineStyle: { color: '#444' } }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Time (s)',
                        axisLabel: { color: '#ccc' },
                        axisLine: { lineStyle: { color: '#444' } },
                        splitLine: { lineStyle: { color: '#333' } }
                    },
                    series: config.series.map(s => ({
                        name: s.name,
                        type: 'bar',
                        stack: 'total',
                        emphasis: { focus: 'series' },
                        data: s.data
                    }))
                };
            }

            return baseOption;
        }

        // Initialize charts after Markdown is rendered
        function initializeCharts(container) {
            const chartElements = container.querySelectorAll('.echart-container[data-chart]');
            const debugLog = [];
            
            debugLog.push(`Found ${chartElements.length} chart placeholder(s)`);
            
            chartElements.forEach((el, index) => {
                try {
                    const configStr = el.dataset.chart;
                    const config = JSON.parse(configStr);
                    
                    debugLog.push(`Chart ${index + 1}: type="${config.type}", title="${config.title}"`);
                    
                    // Initialize ECharts with SVG renderer
                    const chart = echarts.init(el, null, { renderer: 'svg' });
                    
                    // Build and set option
                    const option = buildChartOption(config);
                    chart.setOption(option);
                    
                    // Handle resize
                    window.addEventListener('resize', () => chart.resize());
                    
                    debugLog.push(`  -> Initialized successfully`);
                } catch (err) {
                    debugLog.push(`  -> ERROR: ${err.message}`);
                    el.innerHTML = `<div style="color: #f44; padding: 20px;">Chart error: ${err.message}</div>`;
                }
            });
            
            // Show debug info
            document.getElementById('debug').innerHTML = 
                '<strong>Debug Log:</strong><br>' + debugLog.join('<br>');
        }

        // Main: Render Markdown and initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('report-content');
            
            // Render Markdown
            container.innerHTML = marked.parse(markdownContent);
            
            // Initialize ECharts in placeholders
            initializeCharts(container);
        });
    </script>
</body>
</html>

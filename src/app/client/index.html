<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Three.js Grid + HTML Overlay</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="style/theme.css" />
	<link rel="stylesheet" href="style/gallery.css" />
	<link rel="stylesheet" href="style/hud.css" />
	<link rel="stylesheet" href="style/window.css" />
	<link rel="stylesheet" href="style/menu.css" />
	<link rel="stylesheet" href="style/metrics.css" />	

	<script type="text/javascript" src="./library/socket.io.min.js"></script>
	<script type="text/javascript" src="./library/moveable.min.js"></script>
</head>

<body>

	<div id="root">
		<div id="three-layer"></div>
		<div id="ui-layer">
			<div id="overlay">

				<div>
					<svg width="220" height="50" viewBox="0 0 350 70" xmlns="http://www.w3.org/2000/svg">
						<defs>
							<style type="text/css">
								@import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&amp;family=Inter:wght@400;900&amp;display=swap');
							</style>
							
							<filter id="softShadow" x="-20%" y="-20%" width="150%" height="150%">
								<feGaussianBlur in="SourceAlpha" stdDeviation="2" /> <feOffset dx="2" dy="2" result="offsetblur" /> <feComponentTransfer>
									<feFuncA type="linear" slope="0.3"/> </feComponentTransfer>
								<feMerge>
									<feMergeNode /> <feMergeNode in="SourceGraphic" /> </feMerge>
							</filter>
						</defs>
						<text x="30" y="50" 
							font-family="'Inter', -apple-system, sans-serif" 
							font-size="30" 
							fill="currentColor" 
							filter="url(#softShadow)"> <tspan font-weight="900" fill="#404040">FEM</tspan><tspan font-weight="400">ULATOR</tspan>
							<tspan dx="5" dy="3" font-family="'Dancing Script', cursive" font-size="42" fill="#FB2C36">Pro</tspan>
						</text>
					</svg>
				</div>

				<div id="application-menu-container"></div>

				<div class="hud gallery" id="hud-gallery" style="z-index: 15;">

					<h1>MESH GALLERY</h1>
					<div class="sep"></div>

					<div class="gallery-container" class="gallery-container">

						<div class="caroussel-wrapper">
							<div class="carousel-container">
								<div class="carousel-track" id="carouselTrack">
								</div>
							</div>
							<div class="nav-dots" id="navDots"></div>
							<div class="carousel-controls">
								<button class="btn" id="prevBtn">Previous</button>
								<div class="btn-group">
									<button class="btn btn-secondary" id="cancelBtn">Cancel</button>
									<button class="btn btn-primary" id="selectBtn">Select Model</button>
								</div>
								<button class="btn" id="nextBtn">Next</button>
							</div>
						</div>

					</div>

				</div>

				<div class="hud metrics visible" id="hud-metrics" style="z-index: 15;">

					<h1>PERFORMANCE METRICS</h1>
					<div class="sep"></div>

					<div class="metrics-container">
					</div>

				</div>

				<div class="hud benchmark" id="hud-benchmark" style="z-index: 15;">

					<h1>BENCHMARK ANALYSIS</h1>
					<div class="sep"></div>

					<div class="benchmark-container">
					</div>

				</div>

				<div class="hud report" id="hud-report" style="z-index: 15;">

					<h1>PROJECT REPORT</h1>
					<div class="sep"></div>

					<div class="report-container">
					</div>

				</div>

				<div class="hud settings" id="hud-settings" style="z-index: 15;">

					<h1>CONFIGURATION SETTINGS</h1>
					<div class="sep"></div>

					<div class="settings-container">
					</div>

				</div>

				<div class="hud about" id="hud-about" style="z-index: 15;">

					<h1>ABOUT FEMULATOR PRO</h1>
					<div class="sep"></div>

					<div class="about-container">
					</div>

				</div>


			</div>
		</div>
	</div>

	<script type="module">
		import { MillimetricScene } from './script/scene.js';
		import { FEMClient } from './script/fem-client.js';
		import { MetricsDisplay } from './script/metrics-display.js';
		import { FEMMeshRendererCPU } from './script/fem-mesh-renderer-cpu.js';
		import { FEMMeshRendererGPU } from './script/fem-mesh-renderer-gpu.js';

		// Toggle logic
		const useGPU = true; 

		// Initialize Three.js scene
		const container = document.getElementById('three-layer');
		const millimetricScene = new MillimetricScene(container);

		// Initialize FEM client
		const femClient = new FEMClient('http://localhost:4567');
		const metricsDisplay = new MetricsDisplay(document.getElementById('hud-metrics'));
		
		// Initialize mesh renderer
		const meshRenderer = useGPU ? new FEMMeshRendererGPU(millimetricScene.getScene()) : new FEMMeshRendererCPU(millimetricScene.getScene());

		// Register event handlers
		femClient.on('connected', () => {
			metricsDisplay.updateStatus('Connected');
		});

		femClient.on('stage_start', (data) => {
			metricsDisplay.updateStage(data.stage);
			metricsDisplay.updateStatus('Running');
		});

		femClient.on('mesh_loaded', (data) => {
			metricsDisplay.updateMesh(data.nodes, data.elements);
			
			// Render mesh if coordinates are available
			if (data.coordinates && data.connectivity) {
				meshRenderer.loadMesh(data);
				millimetricScene.render(); // Trigger re-render
			}
		});

		femClient.on('solve_progress', (data) => {
			metricsDisplay.updateProgress(
				data.iteration,
				data.max_iterations,
				data.residual,
				data.etr_seconds
			);
		});

		femClient.on('solve_complete', async (data) => {
			metricsDisplay.updateStatus('Complete');
			metricsDisplay.updateTotalTime(data.timing_metrics.total_program_time);
			console.log('Final results:', data);
			
			// Visualize solution field if available
			if (data.solution_field) {
				meshRenderer.updateSolution({
					values: Array.from(data.solution_field),
					range: data.solution_stats.u_range
				});
				millimetricScene.render();
			}
		});

		femClient.on('solution_increment', (data) => {
			// Update mesh colors in real-time during solving
			meshRenderer.updateSolutionIncremental(data);
			millimetricScene.render();
			
			// Optional: update metrics with current solution range
			console.log(`Solution update: iter ${data.iteration}, ` +
						`range [${data.chunk_info.min.toFixed(3)}, ${data.chunk_info.max.toFixed(3)}]`);
		});	

		// Expose to window for testing
		window.femClient = femClient;
		window.metricsDisplay = metricsDisplay;
		window.meshRenderer = meshRenderer;
		window.millimetricScene = millimetricScene;
	</script>

	<script type="module" src="./script/menu.init.js"></script>
	<script type="module" src="./script/moveable.init.js"></script>

</body>

</html>